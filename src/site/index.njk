---
title: Barrrgh!
---

{% extends "layouts/_base.njk" %}
<!-- prettier-ignore -->
{% block styles %}
{{ super() }}
<link
  href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"
  rel="stylesheet"
/>
{% endblock %}
<!-- prettier-ignore -->
{% block body %}
<header class="flex items-center justify-center sm:mt-8">
  <h1 class="text-6xl">Barrrgh!</h1>
</header>
<main class="flex items-center justify-center">
  <div
    class="w-full sm:w-128 sm:flex-initial p-8 border-t border-b sm:border border-gray-300 sm:rounded bg-white"
  >
    <form id="ingredients-form">
      <div class="flex justify-center mb-4">
        <label for="ingredients-select">What do you want in your drink?</label>
      </div>
      <div class="flex justify-center">
        <select
          id="ingredients-select"
          name="ingredients[]"
          autocomplete="off"
          multiple
          placeholder="Add ingredients ..."
          class="block w-full rounded-sm cursor-pointer focus:outline-none"
        >
          {% for ingredient in collections.ingredientsToDrinks | keys%}
          <option value="{{ ingredient }}">
            {{ ingredient | capitalize }}
          </option>
          {% endfor %}
        </select>
      </div>
    </form>
    <ul id="drinks-list"></ul>
  </div>
</main>
<template id="drink-li-template">
  <li>
    <a href="#" class="block border-b p-4 hover:bg-gray-100">
      <h2 data-drink-li-prop="drinkTitle"></h2>
      <div class="text-xs text-gray-700">
        <span data-drink-li-prop="ingredients"></span>
      </div>
    </a>
  </li>
</template>
<template id="no-match-template">
  <li class="text-center">
    <h2>No drinks with all these ingredients ☠️</h2>
  </li>
</template>
<script id="ingredients-to-drinks-data" type="application/json">
  {{ collections.ingredientsToDrinks | dump | safe }}
</script>
<script id="drink-slugs-to-drinks-data" type="application/json">
  {{ collections.drinkSlugsToDrinks | dump | safe }}
</script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
  // Load data
  const ingredientsToDrinks = JSON.parse(
    document.getElementById("ingredients-to-drinks-data").textContent
  );
  const drinkSlugsToDrinks = JSON.parse(
    document.getElementById("drink-slugs-to-drinks-data").textContent
  );

  // Manage drinks lists
  const DrinkList = function () {
    this.$drinksList = document.getElementById("drinks-list");
    this.$itemTemplate = document.getElementById(
      "drink-li-template"
    ).content.firstElementChild;
    this.$noMatchTemplate = document.getElementById(
      "no-match-template"
    ).content.firstElementChild;
  };

  DrinkList.prototype.createDrinkItemNode = function (drink) {
    const $item = this.$itemTemplate.cloneNode(true);
    const $anchor = $item.children[0];
    $anchor.href = drink.drinkUrl;
    $anchor.querySelector('[data-drink-li-prop="drinkTitle"').innerText =
      drink.drinkTitle;
    $anchor.querySelector(
      '[data-drink-li-prop="ingredients"'
    ).innerText = drink.ingredients.join(", ");
    return $item;
  };

  DrinkList.prototype.renderDrinksList = function (drinkSlugs) {
    const newChildren = [];
    for (const drinkSlug of drinkSlugs) {
      newChildren.push(this.createDrinkItemNode(drinkSlugsToDrinks[drinkSlug]));
    }
    this.$drinksList.replaceChildren(...newChildren);
  };

  DrinkList.prototype.renderNoMatch = function (drinkSlugs) {
    this.$drinksList.replaceChildren(this.$noMatchTemplate.cloneNode(true));
  };

  // Utils
  function intersection(setA, setB) {
    const _intersection = new Set();
    for (const elem of setB) {
      if (setA.has(elem)) {
        _intersection.add(elem);
      }
    }
    return _intersection;
  }

  // Search functionality
  const drinkList = new DrinkList();
  function onIngredientsChange(ingredients) {
    if (ingredients.length === 0) {
      drinkList.renderDrinksList([]);
      return;
    }

    let matchingSlugs = new Set(ingredientsToDrinks[ingredients[0]]);
    for (let i = 1; i < ingredients.length; i++) {
      matchingSlugs = intersection(
        matchingSlugs,
        new Set(ingredientsToDrinks[ingredients[i]])
      );
    }

    if (matchingSlugs.size > 0) {
      drinkList.renderDrinksList(matchingSlugs);
    } else {
      drinkList.renderNoMatch();
    }
  }
  new TomSelect("#ingredients-select", {
    plugins: {
      remove_button: {
        title: "Remove this item",
      },
    },
    closeAfterSelect: true,
    onChange: onIngredientsChange,
  });
</script>
{% endblock %}
